<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>TVT Team ‚Äì FlowLabs Image Creator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              DEFAULT: '#22c55e',
              dark: '#16a34a'
            }
          }
        }
      }
    };
  </script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-300">
  <div class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="border-b border-slate-200 bg-white/80 dark:bg-slate-900/80 dark:border-slate-800 backdrop-blur">
      <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
        <!-- Logo TVT Team -->
        <div class="flex items-center gap-2">
          <!-- Thay b·∫±ng logo SVG / PNG th·∫≠t c·ªßa b·∫°n -->
          <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-500 flex items-center justify-center shadow-md">
            <span class="text-xs font-bold text-white tracking-tight">TVT</span>
          </div>
          <div>
            <p class="text-sm font-semibold leading-tight">TVT Team FlowLabs</p>
            <p class="text-[11px] text-slate-500 dark:text-slate-400">
              Image Prompt Creator (Banana + n8n)
            </p>
          </div>
        </div>

        <!-- Toggle Dark / Light -->
        <button
          id="themeToggle"
          type="button"
          class="flex items-center gap-2 text-[11px] px-2.5 py-1.5 rounded-full border border-slate-200 bg-slate-50 shadow-sm
                 hover:bg-slate-100 active:scale-[0.98]
                 dark:border-slate-700 dark:bg-slate-800 dark:hover:bg-slate-700 transition"
        >
          <span class="theme-label">Light</span>
          <span
            class="relative inline-flex h-4 w-7 items-center rounded-full bg-slate-300 dark:bg-slate-600 transition-colors"
          >
            <span
              class="dot inline-block h-3 w-3 rounded-full bg-white shadow transform translate-x-[3px] dark:translate-x-[16px] transition-transform"
            ></span>
          </span>
        </button>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-1 flex justify-center">
      <div class="w-full max-w-md px-4 py-4">
        <!-- Form -->
        <form
          id="generatorForm"
          class="space-y-4 rounded-2xl border border-slate-200 bg-white/90 shadow-lg shadow-slate-200/60 backdrop-blur
                 dark:border-slate-800 dark:bg-slate-900/80 dark:shadow-black/40 px-4 py-4"
        >
          <!-- Prompt -->
          <div>
            <label for="prompt" class="block text-sm font-medium mb-1">
              M√¥ t·∫£ y√™u c·∫ßu <span class="text-red-500">*</span>
            </label>
            <textarea
              id="prompt"
              class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm
                     focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                     dark:border-slate-700 dark:bg-slate-900/70 dark:focus:ring-primary
                     resize-none min-h-[90px]"
              placeholder="M√¥ t·∫£ c·∫£nh / nh√¢n v·∫≠t / b·ªë c·ª•c b·∫°n mu·ªën t·∫°o (c√†ng chi ti·∫øt c√†ng ra h√¨nh ƒë·∫πp)"
              required
            ></textarea>
            <p class="mt-1 text-[11px] text-slate-500 dark:text-slate-400">
              H·ªá th·ªëng s·∫Ω lu√¥n t·ª± th√™m prefix <code>taoanh:</code> khi g·ª≠i sang n8n (k·ªÉ c·∫£ khi b·∫°n kh√¥ng g√µ).
            </p>
          </div>

          <!-- Style -->
          <div>
            <label for="style" class="block text-sm font-medium mb-1">
              Phong c√°ch
            </label>
            <select
              id="style"
              class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm
                     focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                     dark:border-slate-700 dark:bg-slate-900/70"
            >
              <option value="">-- Kh√¥ng b·∫Øt bu·ªôc --</option>
              <option value="modern, clean, minimal style">Phong c√°ch hi·ªán ƒë·∫°i, t·ªëi gi·∫£n</option>
              <option value="ancient, historical, old painting style">Phong c√°ch c·ªï x∆∞a, c·ªï ƒë·∫°i, l·ªãch s·ª≠</option>
              <option value="fantasy, magical, epic style">Phong c√°ch t∆∞·ªüng t∆∞·ª£ng / Huy·ªÅn ·∫£o</option>
              <option value="ultra realistic, photographic style">Phong c√°ch si√™u th·ª±c</option>
              <option value="2D cartoon, chibi, bright colors">Phong c√°ch ho·∫°t h√¨nh 2D chibi, m√†u s·∫Øc t∆∞∆°i s√°ng</option>
              <option value="anime, cinematic, detailed shading">Phong c√°ch ho·∫°t h√¨nh Anime</option>
            </select>
          </div>

          <!-- Main color -->
          <div>
            <label for="mainColor" class="block text-sm font-medium mb-1">
              M√†u ch·ªß ƒë·∫°o
            </label>
            <select
              id="mainColor"
              class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm
                     focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                     dark:border-slate-700 dark:bg-slate-900/70"
            >
              <option value="">-- Kh√¥ng b·∫Øt bu·ªôc --</option>
              <option value="neon green as main color">Xanh n√µn chu·ªëi</option>
              <option value="red as main color">ƒê·ªè</option>
              <option value="deep blue as main color">Xanh d∆∞∆°ng ƒë·∫≠m</option>
              <option value="pastel colors palette">Pastel nh·∫π nh√†ng</option>
              <option value="black and gold as main colors">ƒêen - V√†ng</option>
              <option value="monochrome, black and white">ƒêen tr·∫Øng</option>
            </select>
          </div>

          <!-- Lighting -->
          <div>
            <label for="lighting" class="block text-sm font-medium mb-1">
              √Ånh s√°ng (g·ª£i √Ω)
            </label>
            <select
              id="lighting"
              class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm
                     focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                     dark:border-slate-700 dark:bg-slate-900/70"
            >
              <option value="">-- Auto / ƒë·ªÉ model t·ª± hi·ªÉu --</option>
              <option value="soft cinematic lighting, gentle shadows">√Ånh s√°ng ƒëi·ªán ·∫£nh d·ªãu nh·∫π, b√≥ng ƒë·ªï tinh t·∫ø.</option>
              <option value="hard dramatic lighting, strong contrast shadows">√Ånh s√°ng ·∫•n t∆∞·ª£ng, ƒë·ªô t∆∞∆°ng ph·∫£n cao.</option>
              <option value="golden hour sunlight, warm and soft">√Ånh n·∫Øng ho√†ng h√¥n, ·∫•m √°p v√† d·ªãu nh·∫π.</option>
              <option value="studio softbox lighting, very clean and bright">Softbox studio, s·∫°ch s·∫Ω v√† s√°ng s·ªßa.</option>
              <option value="neon cyberpunk lighting, purple and blue glow">Phong c√°ch ƒë√®n neon, √°nh s√°ng t√≠m v√† xanh lam.</option>
              <option value="moody low key lighting, dark and mysterious">√Ånh s√°ng m·ªù ·∫£o, u √°m v√† b√≠ ·∫©n.</option>
            </select>
          </div>

          <!-- Background -->
          <div>
            <label for="background" class="block text-sm font-medium mb-1">
              B·ªëi c·∫£nh / N·ªÅn
            </label>
            <select
              id="background"
              class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm
                     focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                     dark:border-slate-700 dark:bg-slate-900/70"
            >
              <option value="">-- Kh√¥ng b·∫Øt bu·ªôc --</option>
              <option value="simple plain background, soft gradient">N·ªÅn ƒë∆°n gi·∫£n / m√†u tr∆°n</option>
              <option value="indoor studio background, clean wall">Trong nh√† / studio</option>
              <option value="outdoor nature background, trees and sky">Ngo√†i tr·ªùi ‚Äì thi√™n nhi√™n</option>
              <option value="outdoor city street background, buildings and lights">Ngo√†i tr·ªùi ‚Äì th√†nh ph·ªë</option>
              <option value="fantasy landscape background, magical environment">Phong c·∫£nh huy·ªÅn ·∫£o / fantasy</option>
              <option value="sci-fi futuristic city background, neon lights">Kh√¥ng gian vi·ªÖn t∆∞·ªüng / sci-fi</option>
            </select>
          </div>

          <!-- Size -->
          <div>
            <label for="size" class="block text-sm font-medium mb-1">
              K√≠ch th∆∞·ªõc mong mu·ªën
            </label>
            <select
              id="size"
              class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm
                     focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                     dark:border-slate-700 dark:bg-slate-900/70"
            >
              <option value="">-- Kh√¥ng b·∫Øt bu·ªôc --</option>
              <option value="name card size, 3.5x2 inches, vertical">Name card (3.5x2 inches, ngang)</option>
              <option value="A4 size, 210x297mm, vertical">A4 d·ªçc (A4 size, d·ªçc)</option>
              <option value="A4 size, 210x297mm, horizontal">A4 ngang (A4 size, ngang)</option>
            </select>
          </div>

          <!-- Aspect Ratio -->
          <div>
            <span class="block text-sm font-medium mb-1">T·ªâ l·ªá khung h√¨nh</span>
            <div class="flex flex-wrap gap-3">
              <label class="flex items-center gap-2 text-sm">
                <input
                  type="radio"
                  name="aspectRatio"
                  value="IMAGE_ASPECT_RATIO_LANDSCAPE"
                  class="text-primary focus:ring-primary"
                />
                <span>16:9 (ngang)</span>
              </label>
              <label class="flex items-center gap-2 text-sm">
                <input
                  type="radio"
                  name="aspectRatio"
                  value="IMAGE_ASPECT_RATIO_PORTRAIT"
                  class="text-primary focus:ring-primary"
                  checked
                />
                <span>9:16 (d·ªçc)</span>
              </label>
            </div>
          </div>

          <!-- Hidden full prompt field (debug) -->
          <textarea
            id="promptFull"
            class="hidden"
            readonly
          ></textarea>

          <!-- Submit -->
          <div class="pt-2">
            <button
              type="submit"
              class="w-full inline-flex items-center justify-center gap-2 rounded-xl bg-primary hover:bg-primary.dark text-white text-sm font-semibold px-4 py-2.5 transition disabled:opacity-60 disabled:cursor-not-allowed"
            >
              <span>T·∫°o h√¨nh ·∫£nh v·ªõi Banana</span>
            </button>
            <p class="mt-2 text-[11px] text-slate-500 dark:text-slate-400">
              Frontend s·∫Ω g·ªçi t·ªõi webhook n8n.
            </p>
          </div>

          <!-- Error message -->
          <p id="errorMessage" class="mt-1 text-sm text-red-500 hidden"></p>
        </form>

        <!-- Result -->
        <section id="resultSection" class="mt-6 hidden">
          <h2 class="text-sm font-semibold mb-2">K·∫øt qu·∫£</h2>
          <div
            id="resultMedia"
            class="rounded-2xl overflow-hidden border border-slate-200 bg-slate-100 min-h-[120px]
                   flex items-center justify-center text-xs text-slate-500
                   dark:border-slate-800 dark:bg-slate-900/80"
          >
            <!-- Media will be injected here -->
          </div>
          <div class="mt-3 flex gap-3">
            <a
              id="downloadBtn"
              href="#"
              class="hidden px-4 py-2 rounded-xl bg-primary hover:bg-primary.dark text-white text-sm font-semibold transition"
              download
            >
              T·∫£i ·∫£nh v·ªÅ
            </a>
            <button
              id="resetBtn"
              class="px-4 py-2 rounded-xl border border-slate-200 text-sm hover:bg-slate-100 transition
                     dark:border-slate-700 dark:hover:bg-slate-800"
            >
              T·∫°o m·ªõi
            </button>
          </div>
        </section>
      </div>
    </main>

    <!-- Loading overlay -->
    <div
      id="loadingOverlay"
      class="fixed inset-0 bg-black/70 backdrop-blur flex flex-col items-center justify-center z-50 hidden"
    >
      <div class="w-14 h-14 border-4 border-emerald-400/30 border-t-emerald-400 rounded-full animate-spin mb-4"></div>
      <p class="text-sm text-slate-100">
        ƒêang t·∫°o h√¨nh ·∫£nh, vui l√≤ng ch·ªù‚Ä¶
      </p>
    </div>
  </div>

  <!-- Script -->
  <script>
    (function () {
      // ===== THEME TOGGLE =====
      const root = document.documentElement;
      const toggleBtn = document.getElementById('themeToggle');
      const label = toggleBtn ? toggleBtn.querySelector('.theme-label') : null;

      const savedTheme = localStorage.getItem('tvt-theme');
      if (savedTheme === 'dark') {
        root.classList.add('dark');
      } else if (savedTheme === 'light') {
        root.classList.remove('dark');
      }

      function updateThemeLabel() {
        const isDark = root.classList.contains('dark');
        if (label) {
          label.textContent = isDark ? 'Dark' : 'Light';
        }
      }
      updateThemeLabel();

      if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          root.classList.toggle('dark');
          const isDark = root.classList.contains('dark');
          localStorage.setItem('tvt-theme', isDark ? 'dark' : 'light');
          updateThemeLabel();
        });
      }

      // ===== FORM + WEBHOOK LOGIC =====
      const form = document.getElementById('generatorForm');
      const loadingOverlay = document.getElementById('loadingOverlay');
      const resultSection = document.getElementById('resultSection');
      const resultMedia = document.getElementById('resultMedia');
      const downloadBtn = document.getElementById('downloadBtn');
      const resetBtn = document.getElementById('resetBtn');
      const errorMessage = document.getElementById('errorMessage');
      const promptFullField = document.getElementById('promptFull');

      // üîó Webhook c·ªßa b·∫°n ‚Äì ch·ªânh l·∫°i path n·∫øu c·∫ßn
      const WEBHOOK_URL = 'https://n8n.taxinamthang.com/webhook/create-image-video-flow';

      function setLoading(isLoading) {
        const elements = form.querySelectorAll('input, textarea, select, button');
        elements.forEach(el => {
          el.disabled = isLoading;
        });
        loadingOverlay.classList.toggle('hidden', !isLoading);
      }

      function buildFullPrompt({ prompt, style, color, lighting, size, background, aspectRatio }) {
        const parts = [];

        if (prompt && prompt.trim()) {
          parts.push(prompt.trim());
        }
        if (style) {
          parts.push('Style: ' + style + '.');
        }
        if (color) {
          parts.push('Main color: ' + color + '.');
        }
        if (lighting) {
          parts.push('Lighting: ' + lighting + '.');
        }
        if (background) {
          parts.push('Background: ' + background + '.');
        }
        if (size) {
          parts.push('Size: ' + size + '.');
        }

        if (aspectRatio === 'IMAGE_ASPECT_RATIO_LANDSCAPE') {
          parts.push('Aspect ratio: 16:9 landscape.');
        } else if (aspectRatio === 'IMAGE_ASPECT_RATIO_PORTRAIT') {
          parts.push('Aspect ratio: 9:16 portrait.');
        }

        return parts.join(' ');
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        errorMessage.classList.add('hidden');
        errorMessage.textContent = '';

        const promptInputEl = document.getElementById('prompt');
        const style = document.getElementById('style').value;
        const color = document.getElementById('mainColor').value;
        const lighting = document.getElementById('lighting').value;
        const background = document.getElementById('background').value;
        const size = document.getElementById('size').value;
        const aspectRatioInput = document.querySelector('input[name="aspectRatio"]:checked');
        const aspectRatio = aspectRatioInput ? aspectRatioInput.value : 'IMAGE_ASPECT_RATIO_PORTRAIT';

        let userPromptRaw = promptInputEl.value || '';
        let basePrompt = userPromptRaw.trim();

        if (!basePrompt) {
          errorMessage.textContent = 'Vui l√≤ng nh·∫≠p n·ªôi dung y√™u c·∫ßu (prompt).';
          errorMessage.classList.remove('hidden');
          return;
        }

        // ‚úÖ Auto th√™m prefix "taoanh:" n·∫øu user kh√¥ng g√µ
        let promptForModel = basePrompt;
        const lower = basePrompt.toLowerCase();
        if (!lower.startsWith('taoanh:')) {
          promptForModel = 'taoanh: ' + basePrompt;
        }

        const type = 'image';

        const promptFull = buildFullPrompt({
          prompt: promptForModel,
          style,
          color,
          lighting,
          size,
          background,
          aspectRatio
        });

        if (promptFullField) {
          promptFullField.value = promptFull;
        }

        const payload = {
          type: type,
          prompt_full: promptFull,
          raw: {
            prompt: promptForModel,
            style: style,
            main_color: color,
            lighting: lighting,
            background: background,
            size: size,
            aspect_ratio: aspectRatio
          }
        };

        setLoading(true);
        resultSection.classList.add('hidden');
        resultMedia.innerHTML = '';
        downloadBtn.classList.add('hidden');

        try {
          const response = await fetch(WEBHOOK_URL, {
            method: 'POST',
            mode: 'cors', // üëà CORS mode (m·∫∑c ƒë·ªãnh ƒë√£ l√† 'cors', nh∆∞ng ƒë·ªÉ r√µ r√†ng)
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          });

          // N·∫øu server ch·∫∑n CORS, error th∆∞·ªùng x·∫£y ra TR∆Ø·ªöC khi t·ªõi ƒë√¢y.
          if (!response.ok) {
            throw new Error('HTTP ' + response.status);
          }

          const data = await response.json();

          if (!data || data.status !== 'success' || !data.url) {
            throw new Error('Ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá t·ª´ n8n');
          }

          const url = data.url;
          resultMedia.innerHTML = '';

          const img = document.createElement('img');
          img.src = url;
          img.alt = 'K·∫øt qu·∫£ t·∫°o h√¨nh ·∫£nh';
          img.loading = 'lazy';
          img.className = 'w-full max-h-[480px] object-contain bg-black';
          resultMedia.appendChild(img);

          downloadBtn.href = url;
          const extFromUrl = (url.split('.').pop() || '').split(/\#|\?/)[0];
          const fallbackExt = 'png';
          const ext = extFromUrl || fallbackExt;
          downloadBtn.download = 'flowlabs-image.' + ext;
          downloadBtn.classList.remove('hidden');

          resultSection.classList.remove('hidden');
        } catch (err) {
          console.error(err);
          // L·ªói CORS trong browser th∆∞·ªùng hi·ªán "TypeError: Failed to fetch"
          const msg = String(err);
          if (msg.includes('TypeError') || msg.toLowerCase().includes('failed to fetch')) {
            errorMessage.textContent =
              'C√≥ th·ªÉ ƒëang b·ªã ch·∫∑n CORS t·ª´ server n8n. H√£y ki·ªÉm tra header Access-Control-Allow-Origin tr√™n n8n / Nginx.';
          } else {
            errorMessage.textContent =
              'C√≥ l·ªói khi g·ªçi n8n: ' + msg + '. Vui l√≤ng ki·ªÉm tra l·∫°i log n8n.';
          }
          errorMessage.classList.remove('hidden');
        } finally {
          setLoading(false);
        }
      });

      resetBtn.addEventListener('click', (e) => {
        e.preventDefault();
        form.reset();
        resultSection.classList.add('hidden');
        resultMedia.innerHTML = '';
        downloadBtn.classList.add('hidden');
        errorMessage.classList.add('hidden');
        errorMessage.textContent = '';
        if (promptFullField) {
          promptFullField.value = '';
        }
      });
    })();
  </script>
</body>
</html>
